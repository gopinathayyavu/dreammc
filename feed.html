<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>DEAR MC — One-Time Feed</title>

  <style>
    :root{
      --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
      --cyan:#00f0ff; --pink:#ff0080; --ink:#111; --fg:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; color:var(--fg);
      min-height:100dvh; background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .wrap{
      width:min(920px,100%); background:#0009; border-radius:16px; padding:24px;
      box-shadow:0 10px 40px #0008; position:relative; overflow:hidden;
    }
    .wrap::before{
      content:""; position:absolute; inset:0; padding:2px; border-radius:16px;
      background-image:linear-gradient(45deg,var(--cyan),var(--pink),var(--cyan));
      background-size:600% 600%; animation:borderRoll 10s linear infinite;
      -webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor; mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);
      mask-composite:exclude; pointer-events:none;
    }
    @keyframes borderRoll{
      0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}
    }
    h1{margin:0 0 6px 0; font-size:24px; letter-spacing:.3px}
    p.sub{margin:0 0 16px 0; opacity:.85}
    .grid{
      display:grid; gap:14px; grid-template-columns:repeat(3,minmax(0,1fr));
    }
    .cell{
      background:#111a; border:1px solid #ffffff20; border-radius:12px; padding:12px;
    }
    label{font-size:12px; opacity:.8; display:block; margin-bottom:6px}
    input[type="date"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #ffffff2f; background:#ffffff15; color:#fff;
      outline:none; font-size:14px;
    }
    .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn{
      background:var(--cyan); color:#111; border:none; border-radius:10px; padding:10px 16px; font-weight:700; cursor:pointer;
    }
    .btn:hover{background:var(--pink); color:#fff}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .muted{opacity:.8; font-size:12px}
    .bar{
      height:8px; background:#ffffff1f; border-radius:999px; overflow:hidden; margin-top:8px;
    }
    .bar>span{
      display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--cyan),var(--pink));
      transition:width .25s ease;
    }
    .log{
      margin-top:14px; background:#0b1318; border:1px solid #ffffff1f; border-radius:12px; padding:12px; height:240px; overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; line-height:1.5;
    }
    .pair{display:grid; grid-template-columns:1fr auto; gap:6px; margin-top:6px}
    a{color:inherit}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #ffffff2a; background:#ffffff12;
    }
  </style>

  <!-- Your Firebase bootstrap (must export { auth, db }) -->
  <script type="module" src="./firebase-init.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>DEAR MC — One-Time Feed</h1>
    <p class="sub">Auto-fill unique 5-digit values for <b>machine</b> & <b>result</b> across all time slots, from <i>June 2025</i> to <i>today</i>.</p>

    <div class="grid">
      <div class="cell">
        <label>Start Date (inclusive)</label>
        <input id="startDate" type="date" value="2025-06-01">
      </div>
      <div class="cell">
        <label>End Date (inclusive)</label>
        <input id="endDate" type="date">
        <div class="muted" id="todayNote"></div>
      </div>
      <div class="cell">
        <label>Options</label>
        <div class="chips">
          <label class="chip"><input id="skipExisting" type="checkbox" checked> &nbsp;Skip existing values</label>
          <label class="chip"><input id="overwriteAll" type="checkbox"> &nbsp;Overwrite all (danger)</label>
        </div>
        <div class="muted">If both are checked, <b>Overwrite all</b> wins.</div>
      </div>
    </div>

    <div class="pair">
      <div class="row">
        <button id="runBtn" class="btn">Run Feed</button>
        <a class="btn" href="./admin.html">Back to Admin</a>
      </div>
      <div>
        <div class="muted" id="stats">Ready.</div>
        <div class="bar"><span id="bar"></span></div>
      </div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js';
    import { ref, get, update, child } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js';

    // -------- CONFIG --------
    const timeSlots = ['10:00 AM','11:00 AM','12:00 PM','01:00 PM','05:00 PM','06:00 PM','07:00 PM','08:00 PM'];

    // -------- DOM --------
    const startDateEl = document.getElementById('startDate');
    const endDateEl   = document.getElementById('endDate');
    const skipExistingEl = document.getElementById('skipExisting');
    const overwriteAllEl = document.getElementById('overwriteAll');
    const runBtn = document.getElementById('runBtn');
    const bar    = document.getElementById('bar');
    const stats  = document.getElementById('stats');
    const logEl  = document.getElementById('log');
    const todayNote = document.getElementById('todayNote');

    // Init end date = today (local)
    const todayIso = fmt(new Date());
    endDateEl.value = todayIso;
    todayNote.textContent = `Today: ${todayIso}`;

    // Require auth (optional — keep if this page must be protected)
    onAuthStateChanged(auth, user => {
      if (!user) {
        appendLog('Not signed in. Redirecting to login…');
        window.location.href = 'index.html';
      } else {
        appendLog(`Signed in as: ${user.email || user.uid}`);
      }
    });

    // Utilities
    function fmt(d){
      const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function appendLog(line){ logEl.textContent += line + '\n'; logEl.scrollTop = logEl.scrollHeight; }
    function setProgress(done,total){
      const pct = total ? Math.round((done/total)*100) : 0;
      bar.style.width = pct + '%';
      stats.textContent = `${done}/${total} (${pct}%)`;
    }
    function* dateRangeIter(startIso,endIso){
      const cur = new Date(startIso + 'T00:00:00');
      const end = new Date(endIso   + 'T00:00:00');
      while(cur <= end){ yield fmt(cur); cur.setDate(cur.getDate()+1); }
    }

    // Generate unique 5-digit randoms avoiding "used"
    function generateUnique(count, usedSet){
      const MIN=10000, MAX=99999, SIZE=(MAX-MIN+1); // 90000
      if(count > (SIZE - usedSet.size)) throw new Error('Not enough remaining unique 5-digit numbers to allocate.');
      const out=[];
      while(out.length < count){
        const n = Math.floor(Math.random()*SIZE) + MIN;
        if(!usedSet.has(n)){
          usedSet.add(n);
          out.push(String(n).padStart(5,'0'));
        }
      }
      return out;
    }

    async function oneTimeFeed(){
      const startIso = startDateEl.value || '2025-06-01';
      const endIso   = endDateEl.value   || fmt(new Date());
      const overwriteAll = overwriteAllEl.checked;
      const skipExisting = skipExistingEl.checked && !overwriteAll;

      // Collect existing & decide targets
      appendLog(`Scanning existing data from ${startIso} → ${endIso} …`);
      const usedNumbers = new Set(); // holds Numbers (not strings) for fast checks
      const targets = [];            // array of { path, kind } where kind ∈ {'machine','result'}

      // First pass — read each date once, collect "used" and figure what to write
      let scannedDates = 0;
      let totalSlots = 0;

      for(const date of dateRangeIter(startIso,endIso)){
        const snap = await get(child(ref(db), `lottery/${date}`));
        const dayData = snap.exists() ? snap.val() : null;

        for(const slot of timeSlots){
          totalSlots++;

          const machinePath = `lottery/${date}/${slot}/machine`;
          const resultPath  = `lottery/${date}/${slot}/result`;

          const existingMachine = dayData?.[slot]?.machine ?? null;
          const existingResult  = dayData?.[slot]?.result  ?? null;

          // Track used numbers so we never reuse
          if(existingMachine && /^\d{5}$/.test(existingMachine)){
            usedNumbers.add(Number(existingMachine));
          }
          if(existingResult && /^\d{5}$/.test(existingResult)){
            usedNumbers.add(Number(existingResult));
          }

          if(overwriteAll){
            targets.push({path:machinePath, kind:'machine'});
            targets.push({path:resultPath,  kind:'result'});
          }else if(skipExisting){
            if(!existingMachine) targets.push({path:machinePath, kind:'machine'});
            if(!existingResult)  targets.push({path:resultPath,  kind:'result'});
          }else{
            // default behavior (same as skipExisting)
            if(!existingMachine) targets.push({path:machinePath, kind:'machine'});
            if(!existingResult)  targets.push({path:resultPath,  kind:'result'});
          }
        }

        scannedDates++;
        setProgress(scannedDates, [...dateRangeIter(startIso,endIso)].length); // light UX tick
      }

      appendLog(`Dates scanned: ${scannedDates}`);
      appendLog(`Time slots per day: ${timeSlots.length} → Total pairs/day: ${timeSlots.length*2}`);
      appendLog(`Existing unique numbers in range: ${usedNumbers.size}`);
      appendLog(`Targets to write: ${targets.length}`);

      if(targets.length === 0){
        appendLog('Nothing to write. All values already present (or overwrite disabled).');
        setProgress(1,1);
        return;
      }

      // Generate required unique numbers (never colliding with existing)
      appendLog('Generating unique 5-digit numbers…');
      const values = generateUnique(targets.length, usedNumbers);

      // Build one big multi-location update (efficient & atomic-ish)
      const updates = {};
      for(let i=0;i<targets.length;i++){
        updates[targets[i].path] = values[i];
      }

      appendLog('Writing to database… (bulk update)');
      await update(ref(db), updates);

      appendLog('✅ Feed complete!');
      setProgress(1,1);
    }

    runBtn.addEventListener('click', async ()=>{
      const startIso = startDateEl.value || '2025-06-01';
      const endIso   = endDateEl.value   || fmt(new Date());
      const overwriteAll = overwriteAllEl.checked;
      const skipExisting = skipExistingEl.checked && !overwriteAll;

      const datesCount = [...dateRangeIter(startIso,endIso)].length;
      const confirmMsg = [
        `This will feed data for ${datesCount} day(s), ${timeSlots.length} slots/day (machine + result).`,
        overwriteAll ? 'Mode: OVERWRITE ALL (existing values will be replaced).' :
        skipExisting ? 'Mode: SKIP existing values. Only empty cells will be filled.' :
                       'Mode: Default (skip existing).',
        'All numbers are globally unique across the entire range (including existing values).',
        '',
        'Proceed?'
      ].join('\n');

      if(!confirm(confirmMsg)) return;

      runBtn.disabled = true;
      runBtn.textContent = 'Running…';
      bar.style.width = '0%';
      logEl.textContent = '';

      try{
        await oneTimeFeed();
        alert('One-time feed completed successfully!');
      }catch(err){
        console.error(err);
        appendLog('❌ Error: ' + (err?.message || err));
        alert('Feed failed — see console/log for details.');
      }finally{
        runBtn.disabled = false;
        runBtn.textContent = 'Run Feed';
      }
    });
  </script>
</body>
</html>
